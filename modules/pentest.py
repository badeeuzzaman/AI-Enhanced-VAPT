"""
Enhanced Penetration Testing Module with service-specific planning
"""

import json
import time
from utils.api_client import DeepSeekClient, APIError, AuthenticationError
from utils.helpers import display_banner, safe_get

class PenetrationTester:
    def __init__(self, config):
        self.config = config
        self.ai_client = DeepSeekClient(config)
        
    def execute(self, assessment_data):
        """Execute penetration test planning phase with enhanced error handling"""
        display_banner("PHASE 4: PENETRATION TEST PLANNING")
        
        if not assessment_data['vulnerability_data']:
            print("ℹ️  No vulnerabilities to plan penetration testing for")
            return True
            
        print("Creating penetration test plan with AI assistance...")
        
        # Set API key
        api_key = assessment_data['client_info'].get('deepseek_api_key')
        if not api_key:
            print("❌ No API key found for penetration test planning")
            return False
            
        self.ai_client.set_api_key(api_key)
        
        try:
            # Create penetration plans for each validated vulnerability
            penetration_plans = []
            
            for i, vulnerability in enumerate(assessment_data['vulnerability_data']):
                # Skip false positives
                if vulnerability.get('is_false_positive', False):
                    continue
                    
                print(f"  Creating test plan for vulnerability {i+1}/{len(assessment_data['vulnerability_data'])}...")
                
                prompt = self._create_service_specific_penetration_prompt(assessment_data, vulnerability)
                
                ai_response = self.ai_client.create_service_specific_penetration_plan(prompt)
                
                if ai_response and isinstance(ai_response, dict):
                    penetration_plans.append(ai_response)
            
            assessment_data['penetration_plan'] = penetration_plans
            print(f"✅ Created {len(penetration_plans)} penetration test plans")
            return True
                
        except AuthenticationError as e:
            print(f"❌ Authentication error: {e}")
            return False
        except APIError as e:
            print(f"❌ API error during penetration test planning: {e}")
            return False
        except Exception as e:
            print(f"❌ Unexpected error during penetration test planning: {e}")
            return False
            
    def _create_service_specific_penetration_prompt(self, assessment_data, vulnerability):
        """Create service-specific penetration test prompt"""
        client_info = assessment_data['client_info']
        
        prompt_template = """
        IMPORTANT: You MUST return ONLY valid JSON format. Do not include any other text.

        As an experienced penetration tester, create a targeted penetration test plan:

        TARGET: {target_ip}
        SERVICE: {service_type} on port {port}
        VULNERABILITY: {vuln_name}
        RISK LEVEL: {risk_level}
        DESCRIPTION: {vuln_description}

        Create a specific penetration test plan for this {service_type} service vulnerability.
        Focus on practical exploitation techniques relevant to {service_type}.

        Return ONLY JSON with this exact structure:
        {{
            "vulnerability": "{vuln_name}",
            "service_type": "{service_type}",
            "port": {port},
            "exploitation_technique": "Specific technique for {service_type}",
            "tools_required": ["tool1", "tool2", ...],
            "test_commands": ["command1", "command2", ...],
            "poc_steps": ["step1", "step2", ...],
            "expected_result": "What to expect when testing this {service_type} vulnerability",
            "evidence_to_collect": ["evidence1", "evidence2", ...],
            "risk_level": "{risk_level}",
            "service_specific_notes": "Additional notes for {service_type} testing"
        }}
        """
        
        return prompt_template.format(
            target_ip=client_info['target_ip'],
            service_type=vulnerability.get('service', 'Unknown'),
            port=vulnerability.get('port', 'Unknown'),
            vuln_name=vulnerability.get('vulnerability_name', 'Unknown'),
            risk_level=vulnerability.get('validated_risk_level', vulnerability.get('risk_level', 'Unknown')),
            vuln_description=vulnerability.get('description', 'No description')
        )